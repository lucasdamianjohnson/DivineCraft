(()=>{"use strict";var e,t,s,n,o,r,i={97420:(e,t,s)=>{s.a(e,(async(e,t)=>{try{var n=s(90439),o=s(69906),r=s(17215),i=s(24579),a=s(42363),c=s(81168),d=s(78083);const e=await(0,n.Z)({});(0,d.A)(e),o.e.init({parent:e.threads.parent,threads:e.threads.constructors});const l=new r.X((()=>o.e.update()),10),u=new r.X((()=>o.e.tick()),50),h=i.$m.createGraph();let g=null;c.QK.registerTask("create-player",(async e=>{g=h.addNode(e).cloneCursor()})),c.QK.registerTask("start-world",(async()=>{if(!g)throw new Error("Player not created yet");const e=a.W.getRequired(g).schema.position;console.warn("start inital load"),await o.e.Procedures.InitalLoad({logTasks:!0,genData:{position:e,renderRadius:150,generationRadius:250,maxRadius:300}});const t=o.e.createGenerator({position:e,renderRadius:150,generationRadius:250,maxRadius:300});o.e.addGenerator(t),console.warn("start building"),u.start(),l.start()})),c.QK.registerTask("world-ready",(()=>{})),t()}catch(e){t(e)}}),1)},17215:(e,t,s)=>{s.d(t,{X:()=>n});class n{stopOnError;_active=!1;interval=1;currentTimeout;__timeoutFunc;constructor(e,t,s=!0){this.stopOnError=s,e&&this.setOnRun(e),void 0!==t&&this.setInterval(t)}setOnRun(e){return this.__timeoutFunc=()=>{this._active&&(e(),this.runInterval())},this}setInterval(e){return this.interval=e,this}runInterval(){this._active&&(this.currentTimeout=setTimeout(this.__timeoutFunc,this.interval))}start(){return this._active||(this._active=!0,this.runInterval()),this}stop(){return this._active=!1,void 0!==this.currentTimeout&&clearTimeout(this.currentTimeout),this.currentTimeout=void 0,this}}},59062:(e,t,s)=>{s.d(t,{j:()=>o});var n=s(78441);class o{center;radius;static Create(e=n.x.Create(),t=1){return new o(e,t)}static IsPointInsideCircle(e,t){const s=e.x-t.center.x,n=e.y-t.center.y;return s*s+n*n<=t.radius*t.radius}static IsSquareInsideCircle(e,t){const s=e.sideLength/2,n={x:e.center.x-s,y:e.center.y-s},o={x:e.center.x+s,y:e.center.y-s},r={x:e.center.x-s,y:e.center.y+s},i={x:e.center.x+s,y:e.center.y+s};return this.IsPointInsideCircle(n,t)&&this.IsPointInsideCircle(o,t)&&this.IsPointInsideCircle(r,t)&&this.IsPointInsideCircle(i,t)}static IsSquareInsideOrTouchingCircle(e,t){const s=e.sideLength/2,n={x:e.center.x-s,y:e.center.y-s},o={x:e.center.x+s,y:e.center.y-s},r={x:e.center.x-s,y:e.center.y+s},i={x:e.center.x+s,y:e.center.y+s};return this.IsPointInsideCircle(n,t)||this.IsPointInsideCircle(o,t)||this.IsPointInsideCircle(r,t)||this.IsPointInsideCircle(i,t)}constructor(e=n.x.Create(),t=1){this.center=e,this.radius=t}}},313:(e,t,s)=>{s.d(t,{j:()=>r.j,M:()=>o});var n=s(78441);class o{center;sideLength;static Create(e=n.x.Create(),t=1){return new o(e,t)}constructor(e=n.x.Create(),t=1){this.center=e,this.sideLength=t}}var r=s(59062)},99673:(e,t,s)=>{s.d(t,{Az:()=>n.Az,M6:()=>o.M,jl:()=>o.j});var n=s(33410),o=s(313);s(93587)},28432:(e,t,s)=>{s.d(t,{j:()=>i});var n=s(87137),o=s(84918),r=s(55725);class i{name;index;threadPoolName;static readySet=new Set;get isRemoteReady(){return i.readySet.has(this)}get isPortSet(){return Boolean(this.port)}port=null;_pool=null;constructor(e,t,s="worker",n=null){this.name=e,this.index=t,this.threadPoolName=s,this._pool=n}setPort(e){if(this.port=e,"browser"==n.Q.environment){const t=e;t.onmessage=e=>{r.E.runInternal(e.data,this,e)},t.onmessageerror=e=>{console.error(`Error occured in from thread ${this.name}`),console.log(e.data),console.log(e)}}if("node"==n.Q.environment){const t=e;t.on("message",(e=>{r.E.runInternal(e,this,e)})),t.on("error",(e=>{console.error(`Error occured in from thread ${this.name}`),console.log(e)}))}this.sendMessage([o.g.setReady,this.name,this.index])}sendMessage(e,t){if(!this.port)throw new Error(`Cannot send message to thread [${this.name}] port is not set`);this.port.postMessage(e,"browser"==n.Q.environment&&t?t:void 0)}connectToThread(e){const t=new MessageChannel;e.sendMessage([o.g.connectPort,this.name,this.threadPoolName,t.port1],[t.port1]),this.sendMessage([o.g.connectPort,e.name,e.threadPoolName,t.port2],[t.port2])}waitTillTaskExist(e,t=50){let s=!1;return new Promise((n=>{const o=e=>{if(s)return clearTimeout(i);e?(s=!0,n(!0),clearTimeout(i)):setTimeout(r,t)},r=()=>{this.taskExist(e,o)};let i=setTimeout(r,t)}))}taskExist(e,t){const s=r.E.getPromiseId();r.z.checkTasks[1]=e,r.z.checkTasks[2]=s,this.sendMessage(r.z.checkTasks),r.E.addPromiseTakss("tasks-check",s,(e=>{t(e)}))}runTask(e,t,s,n){const o=n?r.E.getPromiseId():-1;n&&r.E.addPromiseTakss(e,o,n),r.z.runTask[1]=e,r.z.runTask[2]=o,r.z.runTask[3]=t,this.sendMessage(r.z.runTask,s),r.z.runTask[3]=null}runTaskAsync(e,t,s){return new Promise((n=>{this.runTask(e,t,s,(e=>{n(e)}))}))}waitTillReady(){return new Promise(((e,t)=>{const s=setInterval((()=>{this.isPortSet&&(clearInterval(s),e(!0))}),1)}))}destroy(){i.readySet.delete(this),this.port&&"terminate"in this.port&&this.port.terminate()}}},82938:(e,t,s)=>{s.d(t,{p:()=>r});var n=s(28432),o=s(87137);class r{name;_totalThreads=0;_currentThread=0;__threads=[];constructor(e){this.name=e}getThreads(){return this.__threads}connectToThread(e){for(const t of this.__threads)t.connectToThread(e)}destroyAll(){for(const e of this.__threads)e.destroy()}isReady(){let e=!0;for(const t of this.__threads)t.isPortSet||(e=!1);return e}waitTillAllAreReady(){return new Promise(((e,t)=>{const s=setInterval((()=>{this.isReady()&&(clearInterval(s),e(!0))}),1)}))}addPort(e){const t=`${this.name}-${this._totalThreads}`,s=new n.j(t,this._totalThreads,this.name,this);o.Q.addThread(s),s.setPort(e),this.__threads.push(s),this._totalThreads++}runTaskForAll(e,t,s){for(let n=0;n<this.__threads.length;n++)this.__threads[n].runTask(e,t,s)}runTask(e,t,s,n,o,r){return"number"!=typeof o?(this._currentThread==r&&this.__handleCount(),this.__threads[this._currentThread].runTask(e,t,s,n),this.__handleCount()):(this.__threads[o].runTask(e,t,s,n),o)}runTaskAsync(e,t,s,n,o){return new Promise((r=>{this.runTask(e,t,s,r,n,o)}))}__handleCount(){let e=this._currentThread;return this._currentThread++,this._currentThread>=this._totalThreads&&(this._currentThread=0),e}}},42363:(e,t,s)=>{s.d(t,{W:()=>r});var n=s(24579),o=s(99673);const r=n.$m.registerComponent({type:"transform",schema:n.$m.schema({position:n.$m.property(o.Az.Create(),{type:"vector-3",binary:"f32"}),rotation:n.$m.property(o.Az.Create(),{type:"vector-3",binary:"f32"}),scale:n.$m.property(o.Az.Create(1,1,1),{type:"vector-3",binary:"f32"})},[{id:"shared-array",type:"typed-array",sharedMemory:!0,arrayType:"f32"},{id:"array",type:"typed-array",arrayType:"f32"}])})},78083:(e,t,s)=>{s.d(t,{A:()=>a});var n=s(80740),o=s(67245),r=s(83651);class i extends r.l{tasks;_location=[0,0,0,0];constructor(e){super(),this.tasks=e}mode="async";_mapLocation(){this._location[0]=this.dimension,this._location[1]=this.x,this._location[2]=this.y,this._location[3]=this.z}setMode(e){return this.mode=e,this}paintAndAwaitUpdate(){return new Promise((e=>{this.paintAndUpdate((()=>{e(!0)}))}))}eraseAndAwaitUpdate(){const e=this;return new Promise((t=>{e.eraseAndUpdate((()=>{t(!0)}))}))}paintAndUpdate(e){this._mapLocation(),this.tasks.voxel.paint.run([this._location,this.getRaw()],null,(()=>{e&&e()}))}eraseAndUpdate(e){this._mapLocation(),this.tasks.voxel.erease.run(this._location,null,(()=>{e&&e()}))}update(e){this._mapLocation(),this.tasks.voxel.update.run([this._location,this.getRaw()],null,(()=>{e&&e()}))}updateAndAwait(){return new Promise((e=>{this.update((()=>{e(!0)}))}))}explode(e=6,t){this._mapLocation(),this.tasks.explosion.run([this._location,e],null,(()=>{t&&t()}))}explodeAwaitUpdate(e=6){return new Promise((t=>{this.explode(e,(()=>{t(!0)}))}))}}function a(e){const t=new o.w(e.threads.constructors),s=new i(t);e.TC.registerTask(n.m.RunBuildQueue,(async([e,s])=>{for(const n of s)t.build.section.run([e,...n])})),e.TC.registerTask(n.m.PlaceVoxel,(async([e,[t,n,o],r])=>{s.start(e,t,n,o),console.warn("set the data",{...r}),s.setData(r),console.log(structuredClone(s.getData())),await s.setXYZ(t,n,o).paintAndAwaitUpdate(),s.stop()})),e.TC.registerTask(n.m.RemoveVoxel,(async([e,[t,n,o]])=>{s.start(e,t,n,o),await s.setXYZ(t,n,o).eraseAndAwaitUpdate(),s.stop()})),e.TC.registerTask("build-queue",(async([e,s])=>{for(const n of s)t.build.section.run([e,...n])}))}},90439:(e,t,s)=>{s.d(t,{Z:()=>p});var n=s(27293),o=s(39757),r=s(81168),i=s(39212);class a extends i.Q{constructors=r.QK.createThreadPool("constructor");parent=r.QK.parent;nexus=r.QK.createThread("nexus");constructor(){super(),this.addThread(this.constructors),this.addThread(this.parent)}}class c{static environment="browser";static instance;TC=r.QK;settings=o.i;threads=new a;constructor(){if(c.instance)return c.instance;c.instance=this}}var d=s(75438),l=s(62312),u=s(47096),h=s(55138),g=s(22120);async function p(e={}){const t=new c;c.environment=g.O.isNode()?"node":"browser",r.QK.threadName="world";let s="render";"node"==c.environment&&(s="server"),await r.QK.init("world",self,s);let o=!1;(0,n.A)({onSync(e){e.threads.nexus&&t.threads.addThread(t.threads.nexus),o=!0}}),await new Promise((e=>{const t=()=>{if(o)return e(!0);setTimeout(t,10)};t()}));const i=[t.threads.parent,...t.threads.constructors.getThreads()];return t.threads.nexus.isPortSet&&i.push(t.threads.nexus),function({threads:e,worldStorage:t}){d._.sectors.setSecotrPool(!0);const s=new Map;d._._hooks.sectors.onNew=(t,s)=>{for(const n of e)n.runTask(h.U.SyncSector,[t,s])},d._._hooks.sectors.onRemove=t=>{for(const s of e)s.runTask(h.U.UnSyncSector,t)},d._._hooks.dimension.onNew=t=>{for(const s of e)s.runTask(h.U.SyncDimension,t)},r.QK.registerTask("add-sector",(async n=>{const o=d._.sectors.get(n[0],n[1],n[2],n[3]);if(o)for(const t of e)t.runTask(h.U.SyncSector,[n,o]);else if(o||t||d._.sectors.new(n[0],n[1],n[2],n[3]),t){const e=l.k.sector.getPosition(n[1],n[2],n[3]),o=[n[0],e.x,e.y,e.z],r=o.toString();if(s.has(r))return;s.set(r,!0);const i=await t.loadSector(o);return s.delete(r),void(i||d._.sectors.new(o[0],o[1],o[2],o[3]))}})),r.QK.registerTask("world-alloc",(async e=>{await u.E.addLock(e)})),r.QK.registerTask("world-dealloc",(async e=>{await u.E.removeLock(e)})),r.QK.registerTask("unload-sector",(t=>{if(u.E.isLocked(t))return[!1];d._.sectors.remove(t[0],t[1],t[2],t[3]);for(const s of e)s.runTask(h.U.UnSyncSector,t);return[!1]})),r.QK.registerTask("load-sector",(([t,s])=>{d._.sectors.add(t[0],t[1],t[2],t[3],s);for(const n of e)n.runTask(h.U.SyncSector,[t,s]);return[!0]})),r.QK.registerTask("clear-all",(()=>{d._.clearAll()}))}({threads:i,worldStorage:e.worldStorage}),t}},67245:(e,t,s)=>{s.d(t,{w:()=>d});var n=s(81168),o=s(86081);class r{_task;_queue=[];constructor(e){this._task=e}add(e){this._queue.push(e)}clear(){this._queue.length=0}run(){return new Promise((e=>{let t=0;const s=()=>{t--,t<=0&&e(!0)};for(;this._queue.length;){const e=this._queue.shift();t++,this._task.run(e,null,s)}}))}}class i{id;_count=0;_threads;constructor(e,t){this.id=e,t instanceof n.jV?this._threads=[t]:this._threads=[...t.getThreads()]}run(e,t,s){this._threads[this._count].runTask(this.id,e,t,s),this._count++,this._count>=this._threads.length&&(this._count=0)}runAsync(e,t){return new Promise((s=>{this.run(e,t,s)}))}createQueue(){return new r(this)}}class a{tool;update;paint;erease;logic;constructor(e){this.tool=e,this.update=new i(o.z.VoxelUpdate,e.threads),this.paint=new i(o.z.VoxelPaint,e.threads),this.erease=new i(o.z.VoxelErease,e.threads),this.logic=new i(o.z.LogicUpdate,e.threads)}}class c{tool;section;sector;constructor(e){this.tool=e,this.section=new i(o.z.BuildSection,e.threads),this.sector=new i(o.z.BuildSector,e.threads)}}class d{threads;voxel;build;explosion;anaylzer;propagation;generate;decorate;worldSun;constructor(e){this.threads=e,this.voxel=new a(this),this.build=new c(this),this.explosion=new i(o.z.Explosion,e),this.propagation=new i(o.z.Propagation,e),this.generate=new i(o.z.Generate,e),this.decorate=new i(o.z.Decorate,e),this.worldSun=new i(o.z.WorldSun,e)}}},69906:(e,t,s)=>{s.d(t,{e:()=>W});var n=s(67245),o=s(99673),r=s(59062),i=s(62312);const a=[];class c{tasks;hash=new Set;sections=[];constructor(e){this.tasks=e}add(e,t,s,n){const o=i.k.hash.hashXYZ(t,s,n);if(this.hash.has(o))return!1;this.hash.add(o);const r=a.length?a.shift():[0,0,0,0];r[0]=e,r[1]=t,r[2]=s,r[3]=n,this.sections.push(r)}sort(e,t,s){const n=this.sections,o=e,r=t,i=s;let a,c,d,l,u,h,g,p,_,m,w=n.length;for(;w>1;){for(a=1;a<w;a++)d=n[a-1][1],l=n[a-1][2],u=n[a-1][3],h=n[a][1],g=n[a][2],p=n[a][3],_=(d-o)**2+(l-r)**2+(u-i)**2,m=(h-o)**2+(g-r)**2+(p-i)**2,_>m&&(c=n[a-1],n[a-1]=n[a],n[a]=c);w--}return n}run(e=25){let t=0;for(;this.sections.length;){const s=this.sections.shift(),[,n,o,r]=s;if(this.runTask(s),this.tasks.build.section.run(s),this.hash.delete(i.k.hash.hashXYZ(n,o,r)),t++,a.push(s),t>e)break}}}class d extends c{runTask(e){this.tasks.build.section.run(e)}}class l extends c{runTask(e){this.tasks.voxel.logic.run(e)}}class u{taskTool;position;_dimension=0;_building=!0;_positonChanged=!1;_waitingForCull=!1;_cullTime=0;_culling=!0;_cachedPosition=o.Az.Create();_sectorPosition=o.Az.Create();_genCircle=new r.j({x:0,y:0},0);_renderCircle=new r.j({x:0,y:0},0);_maxCircle=new r.j({x:0,y:0},10);buildQueue;logicQueue;constructor(e,t){this.taskTool=e,this._dimension=t.dimension,this.position=t.position,this._building=void 0===t.building||t.building,this._culling=void 0===t.culling||t.culling,this._renderCircle.radius=t.renderRadius,this._genCircle.radius=t.generationRadius,this._maxCircle.radius=t.maxRadius,this.buildQueue=new d(e),this.logicQueue=new l(e)}update(){this._positonChanged=!1,i.k.section.getPosition(this.position.x,0,this.position.z,this._sectorPosition),o.Az.Equals(this._sectorPosition,this._cachedPosition)||(this._positonChanged=!0,o.Az.Copy(this._cachedPosition,this._sectorPosition)),this._renderCircle.center.x=this._sectorPosition.x,this._renderCircle.center.y=this._sectorPosition.z,this._genCircle.center.x=this._sectorPosition.x,this._genCircle.center.y=this._sectorPosition.z,this._maxCircle.center.x=this._sectorPosition.x,this._maxCircle.center.y=this._sectorPosition.z}tick(){this._building&&(this.buildQueue.sort(this.position.x,this.position.y,this.position.z),this.buildQueue.run(125)),this.logicQueue.sort(this.position.x,this.position.y,this.position.z),this.logicQueue.run()}}var h=s(75438);const g=[],p=[[0,0],[1,0],[0,1],[1,1],[-1,0],[0,-1],[-1,-1],[1,-1],[-1,1]];for(let e=-1;e<2;e++)for(const t of p)g.push([t[0],e,t[1]]);s(52196);var _=s(70522);s(48860);const m=o.Az.Create();function w(e,t,s){t.resset();const[n,o,r]=e.position;for(let e=0;e<p.length;e++){const a=i.k.sector.getPosition(n+p[e][0]*i.k.sector.bounds.x,o,r+p[e][1]*i.k.sector.bounds.z,m);s.vistedMap.has(a.x,o,a.z)||s.queue.push(a.x,o,a.z);const c=h._.sectors.get(s.id,a.x,o,a.z);if(!c){t.genAlldone=!1,t.nWorldGenAllDone=!1,t.nPropagtionAllDone=!1,t.nSunAllDone=!1,t.nDecorAllDone=!1,t.allLoaded=!1;break}c.getBitFlag(_.h.FlagIds.isWorldGenDone)||(t.nWorldGenAllDone=!1),c.getBitFlag(_.h.FlagIds.isWorldDecorDone)||(t.nDecorAllDone=!1),c.getBitFlag(_.h.FlagIds.isWorldSunDone)||(t.nSunAllDone=!1),c.getBitFlag(_.h.FlagIds.isWorldPropagationDone)||(t.nPropagtionAllDone=!1)}return t}class f{isLoaded=!0;isGenerated=!0;genAlldone=!0;allLoaded=!0;nWorldGenAllDone=!0;nDecorAllDone=!0;nSunAllDone=!0;nPropagtionAllDone=!0;resset(){this.isLoaded=!0,this.isGenerated=!0,this.genAlldone=!0,this.allLoaded=!0,this.nWorldGenAllDone=!0,this.nDecorAllDone=!0,this.nSunAllDone=!0,this.nPropagtionAllDone=!0}}var k=s(47096);class T{static taskTool;static worldStorage=null;static parent}const y=o.Az.Create();class x{_map=new Set;get size(){return this._map.size}_getKey(e,t,s){return i.k.hash.hashVec3(i.k.sector.getPosition(e,t,s,y))}has(e,t,s){return this._map.has(this._getKey(e,t,s))}add(e,t,s){this._map.add(this._getKey(e,t,s))}remove(e,t,s){this._map.delete(this._getKey(e,t,s))}clear(){this._map.clear()}}class v{queue=[];vistedMap=new x;waitingFor=0;clear(){this.waitingFor=0,this.queue.length=0,this.vistedMap.clear()}}class S{position;time=0;constructor(e){this.position=e}}class P{nodes=[];addedMap=new x;removeIndex(e){const t=this.nodes.splice(e,1)[0];this.addedMap.remove(...t.position)}inMap(e){return this.addedMap.has(...e.position)}addSector(e){this.addedMap.add(...e.position),this.nodes.push(new S([...e.position]))}}class C{id;tasks=new Map;queue=[];vistedMap=new x;rendered=new x;inProgress=new x;unRenderQueue=new P;unLoadQueue=new P;constructor(e){this.id=e}addTask(e){this.tasks.set(e,new v)}getTask(e){const t=this.tasks.get(e);if(!t)throw new Error(`Task with id [${e}] not registered in dimension segment ${this.id}`);return t}clearAllTasks(){for(const[e,t]of this.tasks)t.clear()}logTasks(){const e=[];for(const[t,s]of this.tasks)e.push(`${t} | ${s.waitingFor}`);return e.join("\n")}}class b{static _dimensions=new Map;static addDimension(e){const t=new C(e);D.addToDimension(t),this._dimensions.set(e,t)}static getDimension(e){const t=this._dimensions.get(e);if(!t)throw new Error(`Dimension with id [${e}] is not registered`);return t}}class I{data;constructor(e){this.data=e}add(e,t,s,n){const o=b.getDimension(e),r=o.getTask(this.data.id);r.vistedMap.has(t,s,n)||this.data.propagationBlocking&&o.inProgress.has(t,s,n)||(r.queue.push(t,s,n),r.vistedMap.add(t,s,n))}remove(e,t,s,n){const o=b.getDimension(e);o.getTask(this.data.id).vistedMap.remove(t,s,n),this.data.propagationBlocking&&o.inProgress.remove(t,s,n)}cancelAll(e=null){if(e)b.getDimension(e).getTask(this.data.id).clear();else for(const[e,t]of b._dimensions)t.clearAllTasks()}runTask(e=1e3){for(const[t,s]of b._dimensions){const t=s.getTask(this.data.id);if(t.waitingFor<0&&(t.waitingFor=0),!(t.waitingFor>=e))for(;t.waitingFor<e&&t.queue.length;){const e=t.queue.shift(),n=t.queue.shift(),o=t.queue.shift();t.waitingFor++,this.data.propagationBlocking&&s.inProgress.add(e,n,o),this.data.run([s.id,e,n,o],(()=>{t.vistedMap.remove(e,n,o),this.data.propagationBlocking&&s.inProgress.remove(e,n,o),t.waitingFor--}),s)}}}}class D{static tasks=[];static addTasks(e){const t=new I(e);return this.tasks.push(t),t}static addToDimension(e){for(const t of this.tasks)e.addTask(t.data.id)}}class A{static worldLoadTasks=D.addTasks({id:"load",propagationBlocking:!0,async run(e,t){const[s,n,o,r]=e;return h._.sectors.get(e[0],n,o,r)?t():T.worldStorage?(await T.worldStorage.loadSector([s,n,o,r])||h._.sectors.new(e[0],n,o,r),void t()):(h._.sectors.new(e[0],n,o,r),t())}});static worldGenTasks=D.addTasks({id:"generate",propagationBlocking:!0,async run(e,t){const s=h._.sectors.get(...e);if(!s)throw new Error(`Sector at ${e.toString()} does not exist when attempting generation.`);if(s.getBitFlag(_.h.FlagIds.isWorldGenDone))return t();T.taskTool.generate.run([e,[]],null,(()=>{s.setBitFlag(_.h.FlagIds.isWorldGenDone,!0),t()}))}});static worldDecorateTasks=D.addTasks({id:"decorate",propagationBlocking:!0,async run(e,t){const s=h._.sectors.get(...e);if(!s)throw new Error(`Sector at ${e.toString()} does not exist when attempting decoration.`);if(s.getBitFlag(_.h.FlagIds.isWorldDecorDone))return t();T.taskTool.decorate.run([e,[]],null,(()=>{s.setBitFlag(_.h.FlagIds.isWorldDecorDone,!0),t()}))}});static worldSunTasks=D.addTasks({id:"wolrd_sun",propagationBlocking:!0,async run(e,t){const s=h._.sectors.get(...e);if(!s)throw new Error(`Sector at ${e.toString()} does not exist when attempting world sun.`);if(s.getBitFlag(_.h.FlagIds.isWorldSunDone))return t();T.taskTool.worldSun.run(e,null,(()=>{s.setBitFlag(_.h.FlagIds.isWorldSunDone,!0),t()}))}});static worldPropagationTasks=D.addTasks({id:"propagation",propagationBlocking:!0,async run(e,t){const s=h._.sectors.get(...e);if(!s)throw new Error(`Sector at ${e.toString()} does not exist when attempting propagation.`);if(s.getBitFlag(_.h.FlagIds.isWorldPropagationDone))return t();T.taskTool.propagation.run(e,null,(()=>{s.setBitFlag(_.h.FlagIds.isWorldPropagationDone,!0),t()}))}});static saveTasks=D.addTasks({id:"save",async run(e,t){if(!T.worldStorage)return t();await T.worldStorage.saveSector(e),t()}});static saveAndUnloadTasks=D.addTasks({id:"save_and_unload",async run(e,t){if(!T.worldStorage)return t();await T.worldStorage.unloadSector(e),t()}})}const z=new f,F=new o.M6,Q=new f,L=new o.M6;function M(e,t,s,n,o,r){let i=!0;e.rendered.has(n,o,r)||(i=!1,e.rendered.add(n,o,r));for(const n of t.getRenerableSections())(!i||!n.isInProgress()&&n.isDisplayDirty())&&(n.setInProgress(!0),s.buildQueue.add(e.id,...n.position))}function R(e,t,s,n,o,r){if(!t.isLogicDirty())return!1;for(const n of t.getLogicDirtySections())!n.isLogicUpdateInProgress()&&n.isLogicDirty()&&(n.setLogicUpdateInProgress(!0),s.logicQueue.add(e.id,...n.position))}const E=new o.M6;async function B(){const e=T.worldStorage;if(!e)return;const t=[];for(const[s]of b._dimensions){const n=h._.dimensions.get(s);for(const[o,r]of n.sectors)r.isStored()||t.push(e.saveSector([s,...r.position]))}await Promise.all(t)}async function G(e){return new Promise((t=>{const s=W.createGenerator({...e.genData,building:!1,culling:!1});b._dimensions.has(s._dimension)||b.addDimension(s._dimension);const n=b.getDimension(e.dimension||0);let o=!1;s._building=!1,W.addGenerator(s);let r=null;const i=()=>{o||(W.update(),r=setTimeout(i,0))};i();const a=setInterval((()=>{let e=!0;for(const[t,s]of n.tasks)if(s.waitingFor>0||s.queue.length>0){e=!1;break}e&&(o=!0,clearInterval(a),clearTimeout(r),W.removeGenerator(s),(async()=>{T.worldStorage&&await B(),t(!0)})())}),100)}))}let q=!1;class W{static _cullGenerators=[];static _generators=[];static addDimension(e){b.addDimension(e)}static Procedures={InitalLoad:G,SaveAllSectors:B};static init(e){q=!0,T.parent=e.parent,T.taskTool=new n.w(e.threads),e.worldStorage&&(T.worldStorage=e.worldStorage)}static createGenerator(e){if(!q)throw new Error("IWG must be initalized first before creating generator");return new u(T.taskTool,{dimension:e.dimension?e.dimension:0,position:e.position?e.position:o.Az.Create(),renderRadius:e.renderRadius?e.renderRadius:150,generationRadius:e.generationRadius?e.generationRadius:250,maxRadius:e.maxRadius?e.maxRadius:300,building:e.building?e.building:void 0})}static addGenerator(e){this._generators.push(e)}static removeGenerator(e){for(let t=0;t<this._generators.length;t++)if(this._generators[t]==e)return this._generators.splice(t,1),!0;return!1}static tick(){for(const e of this._generators)e.tick()}static update(){if(!q)throw new Error("IWG must be initalized.");this._cullGenerators.length&&(this._cullGenerators.length=0);for(const e of this._generators)e.update(),e._culling&&e._positonChanged&&(e._waitingForCull?performance.now()-e._cullTime>4e3&&(e._waitingForCull=!1,this._cullGenerators.push(e)):(e._waitingForCull=!0,e._cullTime=performance.now()));!function(e){for(const t of e){if(!t._building)continue;const e=b._dimensions.get(t._dimension);if(!e)throw new Error(`No segment for dimensions ${t._dimension} found.`);const s=e.queue,n=e.vistedMap,r=t._sectorPosition;for(s.push(r.x,r.y,r.z),t._renderCircle.center.x=r.x,t._renderCircle.center.y=r.z;s.length;){const r=s.shift(),a=s.shift(),c=s.shift();if(n.has(r,a,c))continue;if(n.add(r,a,c),L.sideLength=i.k.sector.bounds.x,L.center.x=r+i.k.sector.bounds.x/2,L.center.y=c+i.k.sector.bounds.z/2,!o.jl.IsSquareInsideOrTouchingCircle(L,t._renderCircle))continue;const d=h._.sectors.get(t._dimension,r,a,c);if(!d)continue;const l=w(d,Q,e);if(l.nWorldGenAllDone&&l.nSunAllDone&&l.nPropagtionAllDone){if(!e.rendered.has(r,a,c)){M(e,d,t,r,a,c);continue}d.anySectionLogicDirty()&&R(e,d,t),d.anySectionDisplayDirty()&&M(e,d,t,r,a,c)}}}for(const[,e]of b._dimensions)e.vistedMap.clear()}(this._generators),function(e){for(const t of e){const e=b._dimensions.get(t._dimension);if(!e)throw new Error(`No segment for dimensions ${t._dimension} found.`);const s=e.queue,n=e.vistedMap,r=t._sectorPosition;for(s.push(r.x,r.y,r.z),t._genCircle.center.x=r.x,t._genCircle.center.y=r.z;s.length;){const r=s.shift(),a=s.shift(),c=s.shift();if(k.E.isLocked([t._dimension,r,a,c])||e.inProgress.has(r,a,c)||n.has(r,a,c))continue;if(n.add(r,a,c),F.sideLength=i.k.sector.bounds.x,F.center.x=r+i.k.sector.bounds.x/2,F.center.y=c+i.k.sector.bounds.z/2,!o.jl.IsSquareInsideOrTouchingCircle(F,t._genCircle))continue;const d=h._.sectors.get(t._dimension,r,a,c);if(!d){A.worldLoadTasks.add(t._dimension,r,a,c);continue}const l=w(d,z,e);d.getBitFlag(_.h.FlagIds.isWorldGenDone),!l.allLoaded||d.getBitFlag(_.h.FlagIds.isWorldGenDone)?!l.nWorldGenAllDone||d.getBitFlag(_.h.FlagIds.isWorldDecorDone)?!l.nDecorAllDone||d.getBitFlag(_.h.FlagIds.isWorldPropagationDone)?!l.nPropagtionAllDone||d.getBitFlag(_.h.FlagIds.isWorldSunDone)||A.worldSunTasks.add(t._dimension,r,a,c):A.worldPropagationTasks.add(t._dimension,r,a,c):A.worldDecorateTasks.add(t._dimension,r,a,c):A.worldGenTasks.add(t._dimension,r,a,c)}}for(const[e,t]of b._dimensions)t.vistedMap.clear()}(this._generators),A.worldLoadTasks.runTask(),A.worldGenTasks.runTask(),A.worldDecorateTasks.runTask(),A.worldSunTasks.runTask(),A.worldPropagationTasks.runTask(),A.saveTasks.runTask(),A.saveAndUnloadTasks.runTask(),function(e,t){const s=performance.now();for(const[,n]of b._dimensions){for(let t=n.unRenderQueue.nodes.length-1;t>-1;t--){const r=n.unRenderQueue.nodes[t],[a,c,d]=r.position;E.center.x=r.position[0]+i.k.sector.bounds.x/2,E.center.y=r.position[2]+i.k.sector.bounds.z/2;let l=!1;for(const t of e)t._dimension==n.id&&o.jl.IsSquareInsideOrTouchingCircle(E,t._renderCircle)&&(l=!0);l?n.unRenderQueue.removeIndex(t):s-r.time>5e3&&(n.rendered.remove(a,c,d),n.inProgress.add(a,c,d),T.parent.runTaskAsync("remove-sector",[n.id,a,c,d]).then((()=>{n.inProgress.remove(a,c,d)})),n.unRenderQueue.removeIndex(t))}for(let t=n.unLoadQueue.nodes.length-1;t>-1;t--){const r=n.unLoadQueue.nodes[t],[a,c,d]=r.position;E.center.x=r.position[0]+i.k.sector.bounds.x/2,E.center.y=r.position[2]+i.k.sector.bounds.z/2;let l=!1;for(const t of e)t._dimension==n.id&&o.jl.IsSquareInsideOrTouchingCircle(E,t._maxCircle)&&(l=!0);l?n.unLoadQueue.removeIndex(t):s-r.time>5e3&&(n.unLoadQueue.removeIndex(t),T.worldStorage?(n.inProgress.add(a,c,d),T.worldStorage.unloadSector([n.id,a,c,d]).finally((()=>{n.inProgress.remove(a,c,d)}))):h._.sectors.remove(n.id,a,c,d))}if(!t.length)continue;const r=h._.dimensions.get(n.id);for(const[,e]of r.sectors){const[s,r,a]=e.position;E.sideLength=i.k.sector.bounds.x,E.center.x=s+i.k.sector.bounds.x/2,E.center.y=a+i.k.sector.bounds.z/2;let c=!1,d=!1;if(!k.E.isLocked([n.id,s,r,a])&&!n.inProgress.has(s,r,a)){for(const e of t)e._dimension==n.id&&(o.jl.IsSquareInsideOrTouchingCircle(E,e._renderCircle)&&(c=!0),o.jl.IsSquareInsideOrTouchingCircle(E,e._maxCircle)&&(d=!0));c&&d||(c||n.unRenderQueue.inMap(e)||n.unRenderQueue.addSector(e),d||n.unLoadQueue.inMap(e)||n.unLoadQueue.addSector(e))}}}}(this._generators,this._cullGenerators)}}W.addDimension(0)},48860:(e,t,s)=>{s.d(t,{p:()=>c});var n=s(99673),o=s(69224),r=s(62312);let i=[];const a=n.Az.Create();class c{sectorCursors={};origin=n.Az.Create();dimension=0;_lastPosition=n.Az.Create();setFocalPoint(e,t,s,n){const o=r.k.sector.getPosition(t,s,n,a);for(const e in this.sectorCursors)for(const t in this.sectorCursors[e]){const s=this.sectorCursors[e][t];s&&(i.push(s),this.sectorCursors[e][t]=null)}this.dimension=e,this.origin.x=o.x/r.k.sector.bounds.x,this.origin.y=o.y/r.k.sector.bounds.y,this.origin.z=o.z/r.k.sector.bounds.z,this.getSector(t,s,n)}inBounds(e,t,s){return r.k.world.inBounds(e,t,s)}getSector(e,t,s){if(!this.inBounds(e,t,s))return null;const n=r.k.sector.getPosition(e,t,s,a),c=n.x/r.k.sector.bounds.x-this.origin.x,d=n.z/r.k.sector.bounds.z-this.origin.z;let l=this.sectorCursors[c]?.[d];if(!l){if(l=i.length?i.shift():new o.j,!l.setSector(this.dimension,n.x,n.y,n.z))return i.push(l),null;this.sectorCursors[c]||(this.sectorCursors[c]??={}),this.sectorCursors[c][d]=l}return l}getVoxel(e,t,s){const n=this.getSector(e,t,s);return n?n.getVoxel(e,t,s):null}}},47096:(e,t,s)=>{s.d(t,{E:()=>r});var n=s(75438),o=s(62312);class r{static locks=new Map;static _loadMap=new Map;static worldStorage=null;static addLock(e){return new Promise((async t=>{this.locks.set(e.toString(),e);const[s,[r,i,a],[c,d,l]]=e,{x:u,y:h,z:g}=o.k.sector.getPosition(r,i,a),{x:p,y:_,z:m}=o.k.sector.getPosition(c,d,l),w=async()=>{let t=!0;for(let r=h;r<_+o.k.sector.bounds.y;r+=o.k.sector.bounds.y)for(let i=u;i<=p;i+=o.k.sector.bounds.x)for(let a=g;a<=m;a+=o.k.sector.bounds.z){const c=o.k.sector.getPosition(i,r,a),d=[e[0],c.x,c.y,c.z];if(d[0]=s,n._.sectors.get(d[0],d[1],d[2],d[3]))continue;t=!1;const l=d.toString();if(this._loadMap.has(l))continue;this._loadMap.set(l,!0);let u=!1;if(this.worldStorage?u=await this.worldStorage.loadSector(d):n._.sectors.get(d[0],d[1],d[2],d[3])&&(u=!0),this._loadMap.delete(l),n._.sectors.get(d[0],d[1],d[2],d[3]))return;u||n._.sectors.new(d[0],d[1],d[2],d[3])}return t};if(await w())return t(!0);const f=async()=>{await w()?t(!0):setTimeout(f,10)};f()}))}static removeLock(e){this.locks.delete(e.toString())}static isLocked([e,t,s,n]){let o=!1;for(const[r,[i,[a,c,d],[l,u,h]]]of this.locks)if(i==e&&!(t>=a&&s>=c&&n>=d&&t<=l&&s<=u&&n<=h)){o=!0;break}return o}}}},a={};function c(e){var t=a[e];if(void 0!==t)return t.exports;var s=a[e]={exports:{}};return i[e](s,s.exports,c),s.exports}c.m=i,c.x=()=>{var e=c.O(void 0,[147,133,433],(()=>c(97420)));return c.O(e)},e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",s="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",n=e=>{e&&e.d<1&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},c.a=(o,r,i)=>{var a;i&&((a=[]).d=-1);var c,d,l,u=new Set,h=o.exports,g=new Promise(((e,t)=>{l=t,d=e}));g[t]=h,g[e]=e=>(a&&e(a),u.forEach(e),g.catch((e=>{}))),o.exports=g,r((o=>{var r;c=(o=>o.map((o=>{if(null!==o&&"object"==typeof o){if(o[e])return o;if(o.then){var r=[];r.d=0,o.then((e=>{i[t]=e,n(r)}),(e=>{i[s]=e,n(r)}));var i={};return i[e]=e=>e(r),i}}var a={};return a[e]=e=>{},a[t]=o,a})))(o);var i=()=>c.map((e=>{if(e[s])throw e[s];return e[t]})),d=new Promise((t=>{(r=()=>t(i)).r=0;var s=e=>e!==a&&!u.has(e)&&(u.add(e),e&&!e.d&&(r.r++,e.push(r)));c.map((t=>t[e](s)))}));return r.r?d:i()}),(e=>(e?l(g[s]=e):d(h),n(a)))),a&&a.d<0&&(a.d=0)},o=[],c.O=(e,t,s,n)=>{if(!t){var r=1/0;for(l=0;l<o.length;l++){for(var[t,s,n]=o[l],i=!0,a=0;a<t.length;a++)(!1&n||r>=n)&&Object.keys(c.O).every((e=>c.O[e](t[a])))?t.splice(a--,1):(i=!1,n<r&&(r=n));if(i){o.splice(l--,1);var d=s();void 0!==d&&(e=d)}}return e}n=n||0;for(var l=o.length;l>0&&o[l-1][2]>n;l--)o[l]=o[l-1];o[l]=[t,s,n]},c.d=(e,t)=>{for(var s in t)c.o(t,s)&&!c.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},c.f={},c.e=e=>Promise.all(Object.keys(c.f).reduce(((t,s)=>(c.f[s](e,t),t)),[])),c.u=e=>e+".bundle.js",c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.p="/",(()=>{var e={501:1};c.f.i=(t,s)=>{e[t]||importScripts(c.p+c.u(t))};var t=self.webpackChunkdivinecraft=self.webpackChunkdivinecraft||[],s=t.push.bind(t);t.push=t=>{var[n,o,r]=t;for(var i in o)c.o(o,i)&&(c.m[i]=o[i]);for(r&&r(c);n.length;)e[n.pop()]=1;s(t)}})(),r=c.x,c.x=()=>Promise.all([147,133,433].map(c.e,c)).then(r),c.x()})();