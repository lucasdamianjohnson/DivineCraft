(()=>{"use strict";var e,t,s,r,n,o,i={97420:(e,t,s)=>{s.a(e,(async(e,t)=>{try{var r=s(90439),n=s(75780),o=s(82495),i=s(24579),a=s(42363),c=s(81168),d=s(78083);const e=await(0,r.Z)({});(0,d.A)(e),n.M.init({parent:e.threads.parent,threads:e.threads.constructors});const l=new o.D((()=>n.M.update()),10),h=new o.D((()=>n.M.tick()),50),u=i.$m.createGraph();let g=null;c.QK.registerTask("create-player",(async e=>{g=u.addNode(e).cloneCursor()})),c.QK.registerTask("start-world",(async()=>{if(!g)throw new Error("Player not created yet");const e=a.W.getRequired(g).schema.position;console.warn("start inital load"),await n.M.Procedures.InitalLoad({dimension:"main",logTasks:!0,genData:{position:e,renderRadius:150,generationRadius:250,maxRadius:300}});const t=n.M.createGenerator({dimension:"main",position:e,renderRadius:150,generationRadius:250,maxRadius:300});n.M.addGenerator(t),console.warn("start building"),h.start(),l.start()})),c.QK.registerTask("world-ready",(()=>{})),t()}catch(e){t(e)}}),1)},82495:(e,t,s)=>{s.d(t,{D:()=>n});var r=s(82825);class n{stopOnError;_active=!1;_run=()=>{};interval=1;currentTimeout;canRun=!0;constructor(e,t,s=!0){this.stopOnError=s,e&&this.setOnRun(e),void 0!==t&&this.setInterval(t)}observers={start:new r.c,stop:new r.c,error:new r.c};setOnRun(e){return this._run=e,this}setInterval(e){return this.interval=e,this}_asyncRun(){return new Promise(((e,t)=>{if(!this.canRun)return e(!1);this.canRun=!1;const s=this._run();if(s instanceof Promise)return s.then((()=>e(!0))).catch((s=>{if(this.stopOnError)return this.stop(),t(s),console.error(s),void this.observers.error.notify(s);this.observers.error.notify(s),e(!1)})).finally((()=>this.canRun=!0));this.canRun=!0,e(!0)}))}runInterval(){this._active&&this._asyncRun().then((()=>{this.currentTimeout=setTimeout((()=>{this._active&&this.runInterval()}),this.interval)}))}start(){return this._active||(this._active=!0,this.runInterval()),this.observers.start.notify(),this}stop(){return this._active=!1,void 0!==this.currentTimeout&&clearTimeout(this.currentTimeout),this.currentTimeout=void 0,this.observers.stop.notify(),this}}},82825:(e,t,s)=>{s.d(t,{c:()=>n});const r=new Set;class n{observersMap=new Map;observers=[];constructor(){}listener(e){return e}subscribe(e,t){if("function"==typeof e&&void 0===t)this.observersMap.set(e,e),this.observers.push(e);else{if(void 0===t)throw new Error("Invalid arguments for subscribe method");this.observersMap.has(e)&&this.unsubscribe(e),this.observersMap.set(e,t),this.observers.push(t)}}unsubscribe(e){const t=this.observersMap.get(e);if(!t)return!1;for(let s=0;s<this.observers.length;s++)if(this.observers[s]==t)return this.observers.splice(s,1),this.observersMap.delete(e),!0;return!1}subscribeOnce(e){this.observers.push(e),r.add(e)}unsubscribeOnce(e){for(let t=0;t<this.observers.length;t++)if(this.observers[t]==e)return this.observers.splice(t,1),r.delete(e),!0;return!1}notify(e){for(let t=this.observers.length-1;t>=0;t--)if(this.observers[t](e,this),r.has(this)&&(this.observers.splice(t,1),r.delete(this)),this._broken)return void(this._broken=!1)}async notifyAsync(e){for(let t=this.observers.length-1;t>=0;t--)if(await this.observers[t](e,this),r.has(this)&&(this.observers.splice(t,1),r.delete(this)),this._broken)return void(this._broken=!1)}clear(){this.observers.length=0,this.observersMap.clear()}_broken=!1;break(){this._broken=!0}}},59062:(e,t,s)=>{s.d(t,{j:()=>n});var r=s(78441);class n{center;radius;static Create(e=r.x.Create(),t=1){return new n(e,t)}static IsPointInsideCircle(e,t){const s=e.x-t.center.x,r=e.y-t.center.y;return s*s+r*r<=t.radius*t.radius}static IsSquareInsideCircle(e,t){const s=e.sideLength/2,r={x:e.center.x-s,y:e.center.y-s},n={x:e.center.x+s,y:e.center.y-s},o={x:e.center.x-s,y:e.center.y+s},i={x:e.center.x+s,y:e.center.y+s};return this.IsPointInsideCircle(r,t)&&this.IsPointInsideCircle(n,t)&&this.IsPointInsideCircle(o,t)&&this.IsPointInsideCircle(i,t)}static IsSquareInsideOrTouchingCircle(e,t){const s=e.sideLength/2,r={x:e.center.x-s,y:e.center.y-s},n={x:e.center.x+s,y:e.center.y-s},o={x:e.center.x-s,y:e.center.y+s},i={x:e.center.x+s,y:e.center.y+s};return this.IsPointInsideCircle(r,t)||this.IsPointInsideCircle(n,t)||this.IsPointInsideCircle(o,t)||this.IsPointInsideCircle(i,t)}constructor(e=r.x.Create(),t=1){this.center=e,this.radius=t}}},313:(e,t,s)=>{s.d(t,{j:()=>o.j,M:()=>n});var r=s(78441);class n{center;sideLength;static Create(e=r.x.Create(),t=1){return new n(e,t)}constructor(e=r.x.Create(),t=1){this.center=e,this.sideLength=t}}var o=s(59062)},99673:(e,t,s)=>{s.d(t,{Az:()=>r.Az,M6:()=>n.M,jl:()=>n.j});var r=s(33410),n=s(313);s(93587)},28432:(e,t,s)=>{s.d(t,{j:()=>i});var r=s(87137),n=s(84918),o=s(55725);class i{name;index;threadPoolName;static readySet=new Set;get isRemoteReady(){return i.readySet.has(this)}get isPortSet(){return Boolean(this.port)}port=null;_pool=null;constructor(e,t,s="worker",r=null){this.name=e,this.index=t,this.threadPoolName=s,this._pool=r}setPort(e){if(this.port=e,"browser"==r.Q.environment){const t=e;t.onmessage=e=>{if(o.E.isInternal(e.data))return o.E.runInternal(e.data,this,e)},t.onmessageerror=e=>{console.error(`Error occured in from thread ${this.name}`),console.log(e.data),console.log(e)}}if("node"==r.Q.environment){const t=e;t.on("message",(e=>{if(o.E.isInternal(e))return o.E.runInternal(e,this,e)})),t.on("error",(e=>{console.error(`Error occured in from thread ${this.name}`),console.log(e)}))}this.sendMessage([o.E.INTERNAL_CODE,n.g.setReady,[this.name,this.index]])}sendMessage(e,t){if(!this.port)throw new Error(`Cannot send message to thread [${this.name}] port is not set`);this.port.postMessage(e,"browser"==r.Q.environment&&t?t:void 0)}connectToThread(e){const t=new MessageChannel;e.sendMessage([o.E.INTERNAL_CODE,n.g.connectPort,[this.name,this.threadPoolName,t.port1]],[t.port1]),this.sendMessage([o.E.INTERNAL_CODE,n.g.connectPort,[e.name,e.threadPoolName,t.port2]],[t.port2])}waitTillTaskExist(e,t=50){let s=!1;return new Promise((r=>{const n=e=>{if(s)return clearTimeout(i);e?(s=!0,r(!0),clearTimeout(i)):setTimeout(o,t)},o=()=>{this.taskExist(e,n)};let i=setTimeout(o,t)}))}taskExist(e,t){const s=o.E.getPromiseId();o.z.checkTasks[2][0]=e,o.z.checkTasks[2][1]=s,this.sendMessage(o.z.checkTasks),o.E.addPromiseTakss("tasks-check",s,(e=>{t(e)}))}runTask(e,t,s,r){const n=r?o.E.getPromiseId():-1;r&&o.E.addPromiseTakss(e,n,r),o.z.runTask[2][0]=e,o.z.runTask[2][1]=n,o.z.runTask[2][2]=t,this.sendMessage(o.z.runTask,s),o.z.runTask[2][2]=null}runTaskAsync(e,t,s){return new Promise((r=>{this.runTask(e,t,s,(e=>{r(e)}))}))}waitTillReady(){return new Promise(((e,t)=>{const s=setInterval((()=>{this.isPortSet&&(clearInterval(s),e(!0))}),1)}))}destroy(){i.readySet.delete(this),this.port&&"terminate"in this.port&&this.port.terminate()}}},82938:(e,t,s)=>{s.d(t,{p:()=>o});var r=s(28432),n=s(87137);class o{name;_totalThreads=0;_currentThread=0;__threads=[];constructor(e){this.name=e}getThreads(){return this.__threads}connectToThread(e){for(const t of this.__threads)t.connectToThread(e)}destroyAll(){for(const e of this.__threads)e.destroy()}isReady(){let e=!0;for(const t of this.__threads)t.isPortSet||(e=!1);return e}waitTillAllAreReady(){return new Promise(((e,t)=>{const s=setInterval((()=>{this.isReady()&&(clearInterval(s),e(!0))}),1)}))}addPort(e){const t=`${this.name}-${this._totalThreads}`,s=new r.j(t,this._totalThreads,this.name,this);n.Q.addThread(s),s.setPort(e),this.__threads.push(s),this._totalThreads++}runTaskForAll(e,t,s){for(let r=0;r<this.__threads.length;r++)this.__threads[r].runTask(e,t,s)}runTask(e,t,s,r,n,o){return"number"!=typeof n?(this._currentThread==o&&this.__handleCount(),this.__threads[this._currentThread].runTask(e,t,s,r),this.__handleCount()):(this.__threads[n].runTask(e,t,s,r),n)}runTaskAsync(e,t,s,r,n){return new Promise((o=>{this.runTask(e,t,s,o,r,n)}))}__handleCount(){let e=this._currentThread;return this._currentThread++,this._currentThread>=this._totalThreads&&(this._currentThread=0),e}}},42363:(e,t,s)=>{s.d(t,{W:()=>o});var r=s(24579),n=s(99673);const o=r.$m.registerComponent({type:"transform",schema:r.$m.schema({position:r.$m.property(n.Az.Create(),{type:"vector-3",binary:"f32"}),rotation:r.$m.property(n.Az.Create(),{type:"vector-3",binary:"f32"}),scale:r.$m.property(n.Az.Create(1,1,1),{type:"vector-3",binary:"f32"})},[{id:"shared-array",type:"typed-array",sharedMemory:!0,arrayType:"f32"},{id:"array",type:"typed-array",arrayType:"f32"}])})},78083:(e,t,s)=>{s.d(t,{A:()=>a});var r=s(80740),n=s(67245),o=s(83651);class i extends o.l{tasks;_location=["main",0,0,0];constructor(e){super(),this.tasks=e}mode="async";_mapLocation(){this._location[0]=this.dimension,this._location[1]=this.x,this._location[2]=this.y,this._location[3]=this.z}setMode(e){return this.mode=e,this}paintAndAwaitUpdate(){return new Promise((e=>{this.paintAndUpdate((()=>{e(!0)}))}))}eraseAndAwaitUpdate(){const e=this;return new Promise((t=>{e.eraseAndUpdate((()=>{t(!0)}))}))}paintAndUpdate(e){this._mapLocation(),this.tasks.voxel.paint.run([this._location,this.getRaw()],null,(()=>{e&&e()}))}eraseAndUpdate(e){this._mapLocation(),this.tasks.voxel.erease.run(this._location,null,(()=>{e&&e()}))}update(e){this._mapLocation(),this.tasks.voxel.update.run([this._location,this.getRaw()],null,(()=>{e&&e()}))}updateAndAwait(){return new Promise((e=>{this.update((()=>{e(!0)}))}))}explode(e=6,t){this._mapLocation(),this.tasks.explosion.run([this._location,e],null,(()=>{t&&t()}))}explodeAwaitUpdate(e=6){return new Promise((t=>{this.explode(e,(()=>{t(!0)}))}))}}function a(e){const t=new n.w(e.threads.constructors),s=new i(t);e.TC.registerTask(r.m.RunBuildQueue,(async([e,s])=>{for(const r of s)t.build.section.run([e,...r])})),e.TC.registerTask(r.m.PlaceVoxel,(async([e,[t,r,n],o])=>{s.start(e,t,r,n),console.warn("set the data",{...o}),s.setData(o),console.log(structuredClone(s.getData())),await s.setXYZ(t,r,n).paintAndAwaitUpdate(),s.stop()})),e.TC.registerTask(r.m.RemoveVoxel,(async([e,[t,r,n]])=>{s.start(e,t,r,n),await s.setXYZ(t,r,n).eraseAndAwaitUpdate(),s.stop()})),e.TC.registerTask("build-queue",(async([e,s])=>{for(const r of s)t.build.section.run([e,...r])}))}},90439:(e,t,s)=>{s.d(t,{Z:()=>p});var r=s(27293),n=s(39757),o=s(81168),i=s(39212);class a extends i.Q{constructors=o.QK.createThreadPool("constructor");parent=o.QK.parent;nexus=o.QK.createThread("nexus");constructor(){super(),this.addThread(this.constructors),this.addThread(this.parent)}}class c{static environment="browser";static instance;TC=o.QK;settings=n.i;threads=new a;constructor(){if(c.instance)return c.instance;c.instance=this}}var d=s(75438),l=s(62312),h=s(47096),u=s(55138),g=s(22120);async function p(e={}){const t=new c;c.environment=g.O.isNode()?"node":"browser",o.QK.threadName="world";let s="render";"node"==c.environment&&(s="server"),await o.QK.init("world",self,s);let n=!1;(0,r.A)({onSync(e){e.threads.nexus&&t.threads.addThread(t.threads.nexus),n=!0}}),await new Promise((e=>{const t=()=>{if(n)return e(!0);setTimeout(t,10)};t()}));const i=[t.threads.parent,...t.threads.constructors.getThreads()];return t.threads.nexus.isPortSet&&i.push(t.threads.nexus),function({threads:e,worldStorage:t}){d._.sectors.setSecotrPool(!0);const s=new Map;d._._hooks.sectors.onNew=(t,s)=>{for(const r of e)r.runTask(u.U.SyncSector,[t,s])},d._._hooks.sectors.onRemove=t=>{for(const s of e)s.runTask(u.U.UnSyncSector,t)},d._._hooks.dimension.onNew=t=>{for(const s of e)s.runTask(u.U.SyncDimension,t)},o.QK.registerTask("add-sector",(async r=>{const n=d._.sectors.get(r[0],r[1],r[2],r[3]);if(n)for(const t of e)t.runTask(u.U.SyncSector,[r,n]);else if(n||t||d._.sectors.new(r[0],r[1],r[2],r[3]),t){const e=l.k.sector.getPosition(r[1],r[2],r[3]),n=[r[0],e.x,e.y,e.z],o=n.toString();if(s.has(o))return;s.set(o,!0);const i=await t.loadSector(n);return s.delete(o),void(i||d._.sectors.new(n[0],n[1],n[2],n[3]))}})),o.QK.registerTask("world-alloc",(async e=>{await h.E.addLock(e)})),o.QK.registerTask("world-dealloc",(async e=>{await h.E.removeLock(e)})),o.QK.registerTask("unload-sector",(t=>{if(h.E.isLocked(t))return[!1];d._.sectors.remove(t[0],t[1],t[2],t[3]);for(const s of e)s.runTask(u.U.UnSyncSector,t);return[!1]})),o.QK.registerTask("load-sector",(([t,s])=>{d._.sectors.add(t[0],t[1],t[2],t[3],s);for(const r of e)r.runTask(u.U.SyncSector,[t,s]);return[!0]})),o.QK.registerTask("clear-all",(()=>{d._.clearAll()}))}({threads:i,worldStorage:e.worldStorage}),t}},75780:(e,t,s)=>{s.d(t,{M:()=>Q});var r=s(67245),n=s(99673),o=s(59062),i=s(62312);class a{tasks;hash=new Set;sections=[];constructor(e){this.tasks=e}add(e){const t=i.k.hash.hashXYZ(e[1],e[2],e[3]);if(this.hash.has(t))return!1;this.hash.add(t),this.sections.push(e)}sort(e,t,s){const r=this.sections,n=e,o=t,i=s;let a,c,d,l,h,u,g,p,_,f,m=r.length;for(;m>1;){for(a=1;a<m;a++)d=r[a-1][1],l=r[a-1][2],h=r[a-1][3],u=r[a][1],g=r[a][2],p=r[a][3],_=(d-n)**2+(l-o)**2+(h-i)**2,f=(u-n)**2+(g-o)**2+(p-i)**2,_>f&&(c=r[a-1],r[a-1]=r[a],r[a]=c);m--}}run(e=25){let t=0;for(;this.sections.length;){const s=this.sections.shift(),[r,n,o,a]=s;if(this.tasks.build.section.run([r,n,o,a]),this.hash.delete(i.k.hash.hashXYZ(n,o,a)),t++,t>e)break}}}class c{taskTool;position;_dimension="main";_building=!0;_positonChanged=!1;_waitingForCull=!1;_cullTime=0;_culling=!0;_cachedPosition=n.Az.Create();_sectorPosition=n.Az.Create();_genCircle=new o.j({x:0,y:0},0);_renderCircle=new o.j({x:0,y:0},0);_maxCircle=new o.j({x:0,y:0},10);buildQueue;constructor(e,t){this.taskTool=e,console.warn("make generator",e),this._dimension=t.dimension,this.position=t.position,this._building=void 0===t.building||t.building,this._culling=void 0===t.culling||t.culling,this._renderCircle.radius=t.renderRadius,this._genCircle.radius=t.generationRadius,this._maxCircle.radius=t.maxRadius,this.buildQueue=new a(e)}update(){this._positonChanged=!1,i.k.section.getPosition(this.position.x,0,this.position.z,this._sectorPosition),n.Az.Equals(this._sectorPosition,this._cachedPosition)||(this._positonChanged=!0,n.Az.Copy(this._cachedPosition,this._sectorPosition)),this._renderCircle.center.x=this._sectorPosition.x,this._renderCircle.center.y=this._sectorPosition.z,this._genCircle.center.x=this._sectorPosition.x,this._genCircle.center.y=this._sectorPosition.z,this._maxCircle.center.x=this._sectorPosition.x,this._maxCircle.center.y=this._sectorPosition.z}tick(){this._building&&(this.buildQueue.sort(this.position.x,this.position.y,this.position.z),this.buildQueue.run(125))}}var d=s(75438);const l=[],h=[[0,0],[1,0],[0,1],[1,1],[-1,0],[0,-1],[-1,-1],[1,-1],[-1,1]];for(let e=-1;e<2;e++)for(const t of h)l.push([t[0],e,t[1]]);s(52196);var u=s(70522);s(48860);const g=n.Az.Create();function p(e,t,s){t.resset();const[r,n,o]=e.position;for(let e=0;e<h.length;e++){const a=i.k.sector.getPosition(r+h[e][0]*i.k.sector.bounds.x,n,o+h[e][1]*i.k.sector.bounds.z,g);s.vistedMap.has(a.x,n,a.z)||s.queue.push(a.x,n,a.z);const c=d._.sectors.get(s.id,a.x,n,a.z);if(!c){t.genAlldone=!1,t.nWorldGenAllDone=!1,t.nPropagtionAllDone=!1,t.nSunAllDone=!1,t.nDecorAllDone=!1,t.allLoaded=!1;break}c.getBitFlag(u.h.FlagIds.isWorldGenDone)||(t.nWorldGenAllDone=!1),c.getBitFlag(u.h.FlagIds.isWorldDecorDone)||(t.nDecorAllDone=!1),c.getBitFlag(u.h.FlagIds.isWorldSunDone)||(t.nSunAllDone=!1),c.getBitFlag(u.h.FlagIds.isWorldPropagationDone)||(t.nPropagtionAllDone=!1)}return t}class _{isLoaded=!0;isGenerated=!0;genAlldone=!0;allLoaded=!0;nWorldGenAllDone=!0;nDecorAllDone=!0;nSunAllDone=!0;nPropagtionAllDone=!0;resset(){this.isLoaded=!0,this.isGenerated=!0,this.genAlldone=!0,this.allLoaded=!0,this.nWorldGenAllDone=!0,this.nDecorAllDone=!0,this.nSunAllDone=!0,this.nPropagtionAllDone=!0}}var f=s(47096);class m{static taskTool;static worldStorage=null;static parent}const w=n.Az.Create();class k{_map=new Set;get size(){return this._map.size}_getKey(e,t,s){return i.k.hash.hashVec3(i.k.sector.getPosition(e,t,s,w))}has(e,t,s){return this._map.has(this._getKey(e,t,s))}add(e,t,s){this._map.add(this._getKey(e,t,s))}remove(e,t,s){this._map.delete(this._getKey(e,t,s))}clear(){this._map.clear()}}class v{queue=[];vistedMap=new k;waitingFor=0;clear(){this.waitingFor=0,this.queue.length=0,this.vistedMap.clear()}}class T{position;time=0;constructor(e){this.position=e}}class y{nodes=[];addedMap=new k;removeIndex(e){const t=this.nodes.splice(e,1)[0];this.addedMap.remove(...t.position)}inMap(e){return this.addedMap.has(...e.position)}addSector(e){this.addedMap.add(...e.position),this.nodes.push(new T([...e.position]))}}class x{id;tasks=new Map;queue=[];vistedMap=new k;rendered=new k;inProgress=new k;unRenderQueue=new y;unLoadQueue=new y;constructor(e){this.id=e}addTask(e){this.tasks.set(e,new v)}getTask(e){const t=this.tasks.get(e);if(!t)throw new Error(`Task with id [${e}] not registered in dimension segment ${this.id}`);return t}clearAllTasks(){for(const[e,t]of this.tasks)t.clear()}logTasks(){const e=[];for(const[t,s]of this.tasks)e.push(`${t} | ${s.waitingFor}`);return e.join("\n")}}class b{static _dimensions=new Map;static addDimension(e){const t=new x(e);S.addToDimension(t),this._dimensions.set(e,t)}static getDimension(e){const t=this._dimensions.get(e);if(!t)throw new Error(`Dimension with id [${e}] is not registered`);return t}}class P{data;constructor(e){this.data=e}add(e,t,s,r){const n=b.getDimension(e),o=n.getTask(this.data.id);o.vistedMap.has(t,s,r)||this.data.propagationBlocking&&n.inProgress.has(t,s,r)||(o.queue.push(t,s,r),o.vistedMap.add(t,s,r))}remove(e,t,s,r){const n=b.getDimension(e);n.getTask(this.data.id).vistedMap.remove(t,s,r),this.data.propagationBlocking&&n.inProgress.remove(t,s,r)}cancelAll(e=null){if(e)b.getDimension(e).getTask(this.data.id).clear();else for(const[e,t]of b._dimensions)t.clearAllTasks()}runTask(e=1e3){for(const[t,s]of b._dimensions){const t=s.getTask(this.data.id);if(t.waitingFor<0&&(t.waitingFor=0),!(t.waitingFor>=e))for(;t.waitingFor<e&&t.queue.length;){const e=t.queue.shift(),r=t.queue.shift(),n=t.queue.shift();t.waitingFor++,this.data.propagationBlocking&&s.inProgress.add(e,r,n),this.data.run([s.id,e,r,n],(()=>{t.vistedMap.remove(e,r,n),this.data.propagationBlocking&&s.inProgress.remove(e,r,n),t.waitingFor--}),s)}}}}class S{static tasks=[];static addTasks(e){const t=new P(e);return this.tasks.push(t),t}static addToDimension(e){for(const t of this.tasks)e.addTask(t.data.id)}}class C{static worldLoadTasks=S.addTasks({id:"load",propagationBlocking:!0,async run(e,t){const[s,r,n,o]=e;return d._.sectors.get(e[0],r,n,o)?t():m.worldStorage?(await m.worldStorage.loadSector([s,r,n,o])||d._.sectors.new(e[0],r,n,o),void t()):(d._.sectors.new(e[0],r,n,o),t())}});static worldGenTasks=S.addTasks({id:"generate",propagationBlocking:!0,async run(e,t){const s=d._.sectors.get(...e);if(!s)throw new Error(`Sector at ${e.toString()} does not exist when attempting generation.`);if(s.getBitFlag(u.h.FlagIds.isWorldGenDone))return t();m.taskTool.generate.run([e,[]],null,(()=>{s.setBitFlag(u.h.FlagIds.isWorldGenDone,!0),t()}))}});static worldDecorateTasks=S.addTasks({id:"decorate",propagationBlocking:!0,async run(e,t){const s=d._.sectors.get(...e);if(!s)throw new Error(`Sector at ${e.toString()} does not exist when attempting decoration.`);if(s.getBitFlag(u.h.FlagIds.isWorldDecorDone))return t();m.taskTool.decorate.run([e,[]],null,(()=>{s.setBitFlag(u.h.FlagIds.isWorldDecorDone,!0),t()}))}});static worldSunTasks=S.addTasks({id:"wolrd_sun",propagationBlocking:!0,async run(e,t){const s=d._.sectors.get(...e);if(!s)throw new Error(`Sector at ${e.toString()} does not exist when attempting world sun.`);if(s.getBitFlag(u.h.FlagIds.isWorldSunDone))return t();m.taskTool.worldSun.run(e,null,(()=>{s.setBitFlag(u.h.FlagIds.isWorldSunDone,!0),t()}))}});static worldPropagationTasks=S.addTasks({id:"propagation",propagationBlocking:!0,async run(e,t){const s=d._.sectors.get(...e);if(!s)throw new Error(`Sector at ${e.toString()} does not exist when attempting propagation.`);if(s.getBitFlag(u.h.FlagIds.isWorldPropagationDone))return t();m.taskTool.propagation.run(e,null,(()=>{s.setBitFlag(u.h.FlagIds.isWorldPropagationDone,!0),t()}))}});static saveTasks=S.addTasks({id:"save",async run(e,t){if(!m.worldStorage)return t();await m.worldStorage.saveSector(e),t()}});static saveAndUnloadTasks=S.addTasks({id:"save_and_unload",async run(e,t){if(!m.worldStorage)return t();await m.worldStorage.unloadSector(e),t()}})}const I=new _,D=new n.M6,A=new _,z=new n.M6;function M(e,t,s,r){let n=!0;e.rendered.has(s[1],s[2],s[3])||(n=!1,e.rendered.add(s[1],s[2],s[3]));for(const e of t.getRenerableSections())(!n||!e.isInProgress()&&e.isDirty())&&(e.setInProgress(!0),r.buildQueue.add([s[0],...e.getPosition()]))}const R=new n.M6;async function E(){const e=m.worldStorage;if(!e)return;const t=[];for(const[s]of b._dimensions){const r=d._.dimensions.get(s);for(const[n,o]of r.sectors)o.isStored()||t.push(e.saveSector([s,...o.position]))}await Promise.all(t)}async function F(e){return new Promise((t=>{const s=Q.createGenerator({...e.genData,building:!1,culling:!1});b._dimensions.has(s._dimension)||b.addDimension(s._dimension);const r=b.getDimension(e.dimension||"main");let n=!1;s._building=!1,Q.addGenerator(s);let o=null;const i=()=>{n||(Q.update(),o=setTimeout(i,0))};i();const a=setInterval((()=>{let e=!0;for(const[t,s]of r.tasks)if(s.waitingFor>0||s.queue.length>0){e=!1;break}e&&(n=!0,clearInterval(a),clearTimeout(o),Q.removeGenerator(s),(async()=>{m.worldStorage&&await E(),t(!0)})())}),100)}))}let L=!1;class Q{static _cullGenerators=[];static _generators=[];static addDimension(e){b.addDimension(e)}static Procedures={InitalLoad:F,SaveAllSectors:E};static init(e){L=!0,m.parent=e.parent,m.taskTool=new r.w(e.threads),e.worldStorage&&(m.worldStorage=e.worldStorage)}static createGenerator(e){if(!L)throw new Error("IWG must be initalized first before creating generator");return new c(m.taskTool,{dimension:e.dimension?e.dimension:"main",position:e.position?e.position:n.Az.Create(),renderRadius:e.renderRadius?e.renderRadius:150,generationRadius:e.generationRadius?e.generationRadius:250,maxRadius:e.maxRadius?e.maxRadius:300,building:e.building?e.building:void 0})}static addGenerator(e){this._generators.push(e)}static removeGenerator(e){for(let t=0;t<this._generators.length;t++)if(this._generators[t]==e)return this._generators.splice(t,1),!0;return!1}static tick(){for(const e of this._generators)e.tick()}static update(){if(!L)throw new Error("IWG must be initalized.");this._cullGenerators.length&&(this._cullGenerators.length=0);for(const e of this._generators)e.update(),e._culling&&e._positonChanged&&(e._waitingForCull?performance.now()-e._cullTime>4e3&&(e._waitingForCull=!1,this._cullGenerators.push(e)):(e._waitingForCull=!0,e._cullTime=performance.now()));!function(e){for(const t of e){if(!t._building)continue;const e=b._dimensions.get(t._dimension);if(!e)throw new Error(`No segment for dimensions ${t._dimension} found.`);const s=e.queue,r=e.vistedMap,o=t._sectorPosition;for(s.push(o.x,o.y,o.z),t._renderCircle.center.x=o.x,t._renderCircle.center.y=o.z;s.length;){const o=s.shift(),a=s.shift(),c=s.shift();if(r.has(o,a,c))continue;if(r.add(o,a,c),z.sideLength=i.k.sector.bounds.x,z.center.x=o+i.k.sector.bounds.x/2,z.center.y=c+i.k.sector.bounds.z/2,!n.jl.IsSquareInsideOrTouchingCircle(z,t._renderCircle))continue;const l=d._.sectors.get(t._dimension,o,a,c);if(!l)continue;const h=p(l,A,e);if(h.nWorldGenAllDone&&h.nSunAllDone&&h.nPropagtionAllDone){if(l.anySectionDirty()){M(e,l,[t._dimension,o,a,c],t);continue}if(e.rendered.has(o,a,c))continue;M(e,l,[t._dimension,o,a,c],t)}}}for(const[,e]of b._dimensions)e.vistedMap.clear()}(this._generators),function(e){for(const t of e){const e=b._dimensions.get(t._dimension);if(!e)throw new Error(`No segment for dimensions ${t._dimension} found.`);const s=e.queue,r=e.vistedMap,o=t._sectorPosition;for(s.push(o.x,o.y,o.z),t._genCircle.center.x=o.x,t._genCircle.center.y=o.z;s.length;){const o=s.shift(),a=s.shift(),c=s.shift();if(f.E.isLocked([t._dimension,o,a,c])||e.inProgress.has(o,a,c)||r.has(o,a,c))continue;if(r.add(o,a,c),D.sideLength=i.k.sector.bounds.x,D.center.x=o+i.k.sector.bounds.x/2,D.center.y=c+i.k.sector.bounds.z/2,!n.jl.IsSquareInsideOrTouchingCircle(D,t._genCircle))continue;const l=d._.sectors.get(t._dimension,o,a,c);if(!l){C.worldLoadTasks.add(t._dimension,o,a,c);continue}const h=p(l,I,e);l.getBitFlag(u.h.FlagIds.isWorldGenDone),!h.allLoaded||l.getBitFlag(u.h.FlagIds.isWorldGenDone)?!h.nWorldGenAllDone||l.getBitFlag(u.h.FlagIds.isWorldDecorDone)?!h.nDecorAllDone||l.getBitFlag(u.h.FlagIds.isWorldPropagationDone)?!h.nPropagtionAllDone||l.getBitFlag(u.h.FlagIds.isWorldSunDone)||C.worldSunTasks.add(t._dimension,o,a,c):C.worldPropagationTasks.add(t._dimension,o,a,c):C.worldDecorateTasks.add(t._dimension,o,a,c):C.worldGenTasks.add(t._dimension,o,a,c)}}for(const[e,t]of b._dimensions)t.vistedMap.clear()}(this._generators),C.worldLoadTasks.runTask(),C.worldGenTasks.runTask(),C.worldDecorateTasks.runTask(),C.worldSunTasks.runTask(),C.worldPropagationTasks.runTask(),C.saveTasks.runTask(),C.saveAndUnloadTasks.runTask(),function(e,t){const s=performance.now();for(const[,r]of b._dimensions){for(let t=r.unRenderQueue.nodes.length-1;t>-1;t--){const o=r.unRenderQueue.nodes[t],[a,c,d]=o.position;R.center.x=o.position[0]+i.k.sector.bounds.x/2,R.center.y=o.position[2]+i.k.sector.bounds.z/2;let l=!1;for(const t of e)t._dimension==r.id&&n.jl.IsSquareInsideOrTouchingCircle(R,t._renderCircle)&&(l=!0);l?r.unRenderQueue.removeIndex(t):s-o.time>5e3&&(r.rendered.remove(a,c,d),r.inProgress.add(a,c,d),m.parent.runTaskAsync("remove-sector",[r.id,a,c,d]).then((()=>{r.inProgress.remove(a,c,d)})),r.unRenderQueue.removeIndex(t))}for(let t=r.unLoadQueue.nodes.length-1;t>-1;t--){const o=r.unLoadQueue.nodes[t],[a,c,l]=o.position;R.center.x=o.position[0]+i.k.sector.bounds.x/2,R.center.y=o.position[2]+i.k.sector.bounds.z/2;let h=!1;for(const t of e)t._dimension==r.id&&n.jl.IsSquareInsideOrTouchingCircle(R,t._maxCircle)&&(h=!0);h?r.unLoadQueue.removeIndex(t):s-o.time>5e3&&(r.unLoadQueue.removeIndex(t),m.worldStorage?(r.inProgress.add(a,c,l),m.worldStorage.unloadSector([r.id,a,c,l]).finally((()=>{r.inProgress.remove(a,c,l)}))):d._.sectors.remove(r.id,a,c,l))}if(!t.length)continue;const o=d._.dimensions.get(r.id);for(const[,e]of o.sectors){const[s,o,a]=e.position;R.sideLength=i.k.sector.bounds.x,R.center.x=s+i.k.sector.bounds.x/2,R.center.y=a+i.k.sector.bounds.z/2;let c=!1,d=!1;if(!f.E.isLocked([r.id,s,o,a])&&!r.inProgress.has(s,o,a)){for(const e of t)e._dimension==r.id&&(n.jl.IsSquareInsideOrTouchingCircle(R,e._renderCircle)&&(c=!0),n.jl.IsSquareInsideOrTouchingCircle(R,e._maxCircle)&&(d=!0));c&&d||(c||r.unRenderQueue.inMap(e)||r.unRenderQueue.addSector(e),d||r.unLoadQueue.inMap(e)||r.unLoadQueue.addSector(e))}}}}(this._generators,this._cullGenerators)}}Q.addDimension("main")},67245:(e,t,s)=>{s.d(t,{w:()=>d});var r=s(81168),n=s(86081);class o{_task;_queue=[];constructor(e){this._task=e}add(e){this._queue.push(e)}clear(){this._queue.length=0}run(){return new Promise((e=>{let t=0;const s=()=>{t--,t<=0&&e(!0)};for(;this._queue.length;){const e=this._queue.shift();t++,this._task.run(e,null,s)}}))}}class i{id;_count=0;_threads;constructor(e,t){this.id=e,t instanceof r.jV?this._threads=[t]:this._threads=[...t.getThreads()]}run(e,t,s){this._threads[this._count].runTask(this.id,e,t,s),this._count++,this._count>=this._threads.length&&(this._count=0)}runAsync(e,t){return new Promise((s=>{this.run(e,t,s)}))}createQueue(){return new o(this)}}class a{tool;update;paint;erease;constructor(e){this.tool=e,this.update=new i(n.z.VoxelUpdate,e.threads),this.paint=new i(n.z.VoxelPaint,e.threads),this.erease=new i(n.z.VoxelErease,e.threads)}}class c{tool;section;sector;constructor(e){this.tool=e,this.section=new i(n.z.BuildSection,e.threads),this.sector=new i(n.z.BuildSector,e.threads)}}class d{threads;voxel;build;explosion;anaylzer;propagation;generate;decorate;worldSun;constructor(e){this.threads=e,this.voxel=new a(this),this.build=new c(this),this.explosion=new i(n.z.Explosion,e),this.propagation=new i(n.z.Propagation,e),this.generate=new i(n.z.Generate,e),this.decorate=new i(n.z.Decorate,e),this.worldSun=new i(n.z.WorldSun,e)}}},48860:(e,t,s)=>{s.d(t,{p:()=>c});var r=s(99673),n=s(69224),o=s(62312);let i=[];const a=r.Az.Create();class c{sectorCursors=new Map;origin={x:0,y:0,z:0};dimension="";setFocalPoint(e,t,s,r){const n=o.k.sector.getPosition(t,s,r,a);for(const[e,t]of this.sectorCursors)for(const[e,s]of t)i.push(s);this.sectorCursors.clear(),this.dimension=e,this.origin.x=n.x/o.k.sector.bounds.x,this.origin.y=n.y/o.k.sector.bounds.y,this.origin.z=n.z/o.k.sector.bounds.z}inBounds(e,t,s){return o.k.world.inBounds(e,t,s)}getSector(e,t,s){if(!this.inBounds(e,t,s))return null;const r=o.k.sector.getPosition(e,t,s,a),c=r.x/o.k.sector.bounds.x-this.origin.x,d=r.z/o.k.sector.bounds.z-this.origin.z;let l=this.sectorCursors.get(c),h=l?.get(d);if(!h){if(h=i.length?i.shift():new n.j,!h.setSector(this.dimension,r.x,r.y,r.z))return i.push(h),null;l||(l=new Map,this.sectorCursors.set(c,l)),l.set(d,h)}return h}getVoxel(e,t,s){const r=this.getSector(e,t,s);return r?r.getVoxel(e,t,s):null}}},47096:(e,t,s)=>{s.d(t,{E:()=>o});var r=s(75438),n=s(62312);class o{static locks=new Map;static _loadMap=new Map;static worldStorage=null;static addLock(e){return new Promise((async t=>{this.locks.set(e.toString(),e);const[s,[o,i,a],[c,d,l]]=e,{x:h,y:u,z:g}=n.k.sector.getPosition(o,i,a),{x:p,y:_,z:f}=n.k.sector.getPosition(c,d,l),m=async()=>{let t=!0;for(let o=u;o<_+n.k.sector.bounds.y;o+=n.k.sector.bounds.y)for(let i=h;i<=p;i+=n.k.sector.bounds.x)for(let a=g;a<=f;a+=n.k.sector.bounds.z){const c=n.k.sector.getPosition(i,o,a),d=[e[0],c.x,c.y,c.z];if(d[0]=s,r._.sectors.get(d[0],d[1],d[2],d[3]))continue;t=!1;const l=d.toString();if(this._loadMap.has(l))continue;this._loadMap.set(l,!0);let h=!1;if(this.worldStorage?h=await this.worldStorage.loadSector(d):r._.sectors.get(d[0],d[1],d[2],d[3])&&(h=!0),this._loadMap.delete(l),r._.sectors.get(d[0],d[1],d[2],d[3]))return;h||r._.sectors.new(d[0],d[1],d[2],d[3])}return t};if(await m())return t(!0);const w=async()=>{await m()?t(!0):setTimeout(w,10)};w()}))}static removeLock(e){this.locks.delete(e.toString())}static isLocked([e,t,s,r]){let n=!1;for(const[o,[i,[a,c,d],[l,h,u]]]of this.locks)if(i==e&&!(t>=a&&s>=c&&r>=d&&t<=l&&s<=h&&r<=u)){n=!0;break}return n}}}},a={};function c(e){var t=a[e];if(void 0!==t)return t.exports;var s=a[e]={exports:{}};return i[e](s,s.exports,c),s.exports}c.m=i,c.x=()=>{var e=c.O(void 0,[147,133,433],(()=>c(97420)));return c.O(e)},e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",s="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",r=e=>{e&&e.d<1&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},c.a=(n,o,i)=>{var a;i&&((a=[]).d=-1);var c,d,l,h=new Set,u=n.exports,g=new Promise(((e,t)=>{l=t,d=e}));g[t]=u,g[e]=e=>(a&&e(a),h.forEach(e),g.catch((e=>{}))),n.exports=g,o((n=>{var o;c=(n=>n.map((n=>{if(null!==n&&"object"==typeof n){if(n[e])return n;if(n.then){var o=[];o.d=0,n.then((e=>{i[t]=e,r(o)}),(e=>{i[s]=e,r(o)}));var i={};return i[e]=e=>e(o),i}}var a={};return a[e]=e=>{},a[t]=n,a})))(n);var i=()=>c.map((e=>{if(e[s])throw e[s];return e[t]})),d=new Promise((t=>{(o=()=>t(i)).r=0;var s=e=>e!==a&&!h.has(e)&&(h.add(e),e&&!e.d&&(o.r++,e.push(o)));c.map((t=>t[e](s)))}));return o.r?d:i()}),(e=>(e?l(g[s]=e):d(u),r(a)))),a&&a.d<0&&(a.d=0)},n=[],c.O=(e,t,s,r)=>{if(!t){var o=1/0;for(l=0;l<n.length;l++){for(var[t,s,r]=n[l],i=!0,a=0;a<t.length;a++)(!1&r||o>=r)&&Object.keys(c.O).every((e=>c.O[e](t[a])))?t.splice(a--,1):(i=!1,r<o&&(o=r));if(i){n.splice(l--,1);var d=s();void 0!==d&&(e=d)}}return e}r=r||0;for(var l=n.length;l>0&&n[l-1][2]>r;l--)n[l]=n[l-1];n[l]=[t,s,r]},c.d=(e,t)=>{for(var s in t)c.o(t,s)&&!c.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},c.f={},c.e=e=>Promise.all(Object.keys(c.f).reduce(((t,s)=>(c.f[s](e,t),t)),[])),c.u=e=>e+".bundle.js",c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.p="/",(()=>{var e={501:1};c.f.i=(t,s)=>{e[t]||importScripts(c.p+c.u(t))};var t=self.webpackChunkdivinecraft=self.webpackChunkdivinecraft||[],s=t.push.bind(t);t.push=t=>{var[r,n,o]=t;for(var i in n)c.o(n,i)&&(c.m[i]=n[i]);for(o&&o(c);r.length;)e[r.pop()]=1;s(t)}})(),o=c.x,c.x=()=>Promise.all([147,133,433].map(c.e,c)).then(o),c.x()})();